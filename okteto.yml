name: movies

dependencies:
  mongodb:
    repository: https://github.com/okteto/mongodb
    wait: true
    variables:
      MONGODB_PASSWORD: ${MONGODB_PASSWORD}

build:
  api:
    context: api
  frontend:
    context: frontend
  e2e:
    context: e2e

deploy:
  - name: Helm Install
    command: |
      helm upgrade --install movies chart \
        --set mongodb.password=${MONGODB_PASSWORD} \
        --set seed.enabled=true \
        --set api.image=${OKTETO_BUILD_API_IMAGE} \
        --set frontend.image=${OKTETO_BUILD_FRONTEND_IMAGE} \
        --set e2e.image=${OKTETO_BUILD_E2E_IMAGE}

dev:
  api:
    command: bash
    sync:
      - api:/src
    forward:
      - 9229:9229

  frontend:
    image: okteto/node:20
    command: bash
    sync:
      - frontend:/usr/src/app

  e2e:
    image: okteto/node:20
    command: bash
    sync:
      - e2e:/usr/src/app

test:
  e2e:
    context: e2e
    image: ${OKTETO_BUILD_E2E_IMAGE}
    commands:
      # If test fails, we don't want to fail the pipeline so we exit with 0, otherwise
      # the artifacts won't be synced.
      - |
        export MONGODB_PASSWORD=password
        export MONGODB_USERNAME=okteto
        export MONGODB_DATABASE=okteto
        export MONGODB_HOST=mongodb
        yarn test || exit 0
    artifacts:
      - test-results
      - playwright-report

  api:
    context: api
    image: ${OKTETO_BUILD_API_IMAGE}
    commands:
      - yarn test
